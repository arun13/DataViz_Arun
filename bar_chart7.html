<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Load d3-annotation -->
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.js"></script>

<div id="scene_two"></div>

<script>

  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

  // Parse the date / time
  var parseDate = d3.timeParse("%m/%d/%Y");

  var margin = {top: 10, right: 60, bottom: 30, left: 60},
          width = 1200 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

  var svg = d3.select("#scene_two")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform","translate(" + margin.left + "," + margin.top + ")");

  const formatMonthYear = d3.timeFormat("%b%y");
  //Read the data
  d3.csv("data/owid-covid-data_test.csv", function(data) {

    var data = data.filter(function(d){
      return d.location == "Germany";
    });


    data.forEach(function(d) {
      d.date = parseDate(d.date);
      d.value = +d.new_deaths;
      //   console.log(d.location+" "+d.date+" "+d.value)
    });

    data.forEach(function(d) {
      const formatMonthYear = d3.timeFormat("%b%y");
      d.date = formatMonthYear(d.date);
      d.value = parseInt(d.value);
      console.log(d.location+" "+d.date+" "+d.value);
    });
    //sample
    /*      var array = [
              { Id: "001", qty: 1 },
              { Id: "002", qty: 2 },
              { Id: "001", qty: 2 },
              { Id: "003", qty: 4 }
          ];

          var result = [];
          array.reduce(function(res, value) {
              if (!res[value.Id]) {
                  res[value.Id] = { Id: value.Id, qty: 0 };
                  result.push(res[value.Id])
              }
              res[value.Id].qty += value.qty;
              return res;
          }, {});

          console.log(result)
  */
    ///sample
    var formatted_data=[];
    data.reduce(function(outValue,inValue) {
      if (!outValue[inValue.date]) {
        outValue[inValue.date] = { date: inValue.date,location: inValue.location, value: inValue.value };
        formatted_data.push(outValue[inValue.date]);
      }
      // console.log(d.location+" "+d.date+" "+d.value)
      outValue[inValue.date].value += inValue.value;
      return outValue;
    }, {});

    console.log(formatted_data);


    var x = d3.scaleBand()
            .domain(d3.extent(formatted_data, function(d) {
              return d.date }))
            .rangeRound([0, width], .05).padding(0.1);

    var y = d3.scaleLinear()
            .domain([0, d3.sum(formatted_data, function(d) { return +d.value; })])
            //.domain([0, d3.max(data, function(d) { return +d.new_deaths; })])
            .range([height, 0]);

    var xAxis = d3.axisBottom(x)
            .scale(x)
    //.tickFormat(d3.timeFormat("%b%y"));
    //.tickFormat(d3.timeFormat("%b%y"));

    var yAxis = d3.axisLeft()
            .scale(y)
            .ticks(20);
    /*
          var x = d3.scaleTime()
              .domain(d3.extent(data, function(d) {
                  return d.date }))
              .range([ 0, width ]);
          var xAxis = svg.append("g")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b%y")).ticks(17));

          // Add Y axis
          var y = d3.scaleLinear()
              .domain([0, d3.max(data, function(d) { return +d.new_cases_per_million; })])
              .range([ height, 0 ]);
          var yAxis = svg.append("g")
              .call(d3.axisLeft(y));
    */
    /*    var colors = d3.scaleLinear()
            .domain([0, d3.sum(formatted_data, function(d) { return +d.value; })])
            .range(['#3FC974', '#f1d229', '#da682b', '#ee232c'])*/

    //   var max =120000;

    var max = formatted_data.reduce(function(prev, current) {
      return (prev.value > current.value) ? prev : current
    })
    console.log(max);
    var colors = d3.scaleLinear()
            .domain([0, max.value * .33, max.value * .66, max.value])
            .range(['#3FC974', '#f1d229', '#da682b', '#ee232c']);

    x.domain(formatted_data.map(function(d) { return d.date; }));
    y.domain([0, d3.max(formatted_data, function(d) { return d.value; })]);

    svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis.ticks(null).tickSize(0))
            .selectAll("text")
            .style("text-anchor", "middle")
//       .attr("dx", "-.8em")
//       .attr("dy", "-.55em")
//       .attr("transform", "rotate(-90)" );

    svg.append("g")
            .attr("class", "y axis")
            .call(yAxis.ticks(null).tickSize(0))
            .append("text")
            //       .attr("transform", "rotate(-90)")
            .attr("y", 6)
            //       .attr("dy", ".71em")
            .style("text-anchor", "middle");
    // .text("Value");

    svg.selectAll("bar")
            .data(formatted_data)
            .enter().append("rect")
            .style("fill", function(d){ return colors(d.value)})
            .attr("x", function(d) { return x(d.date); })
            .attr("width", x.bandwidth())
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); });
    /* svg.selectAll("lines")
             .data(data)
             .enter().append("line")
             .style("fill", 'none')
             .attr("x1", function(d) { return x(d.date) + x.bandwidth()+5; })
             .attr("x2", function(d) { return x(d.date)-5; })
             .attr("y1", function(d) { return y(d.target); })
             .attr("y2", function(d) { return y(d.target); })
             .style("stroke-dasharray", [2,2])
             .style("stroke", "#000000")
             .style("stroke-width", 2)*/

  });

</script>