<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link rel="stylesheet" href="style/main.css">
</head>
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Load d3-annotation -->
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.js"></script>
<div id="country_selection"></div>
<div id="scene_two"></div>

<script>

    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    // Parse the date / time
    var parseDate = d3.timeParse("%m/%d/%Y");

    var margin = {top: 10, right: 60, bottom: 30, left: 60},
        width = 1200 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var svg = d3.select("#scene_two")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform","translate(" + margin.left + "," + margin.top + ")");

    //Read the data
    d3.csv("data/owid-covid-data_test.csv", function(data) {

        // Added dropdown
        var sumstat = d3.nest() // nest function allows to group the calculation per level of a factor
            .key(function(d) { return d.location;})
            .entries(data);

        var select = d3.select('#country_selection')
            .append('select')
            // .attr('class','select')
            .attr('class','box')
            .on('change',onchange)

        var options = select
            .selectAll('option')
            .data(sumstat).enter()
            .append('option')
            .attr("selected", function(d){
                return d === "India"
            })
            .text(function (d) { return d.key; });

        function onchange() {
            selectValue = d3.select('select').property('value')
            //console.log("before ",data);
            updateChart(selectValue,data);
        }
        // to get data formatted
        function format_data(tobeformatdata)
        {
            tobeformatdata.forEach(function (d) {
                d.parsed_date = parseDate(d.date);
                d.sti_index = +d.stringency_index;
                d.new_cases_per_million = +d.new_cases_per_million;
              //  console.log(d.location+" "+d.parsed_date+" "+d.sti_index+" "+d.new_cases_per_million);
            });
            return tobeformatdata;
        }
        function transition(path) {
            path.transition()
                .duration(7500)
                .attrTween("stroke-dasharray", tweenDash)
                .on("end", () => { d3.select(this).call(transition); });
        }

        function tweenDash() {
            const l = this.getTotalLength(),
                i = d3.interpolateString("0," + l, l + "," + l);
            return function(t) { return i(t) };
        }
        // color palette
        var res = sumstat.map(function(d){ return d.key }) // list of group names
        var color = d3.scaleOrdinal()
            .domain(res)
            .range(d3['schemeCategory10'])
        /////
        function initGraph(rawdata)
        {
            var counry_data = rawdata.filter(function(d){
                return d.location == "India";
            });
            var formatted_data=format_data(counry_data);
            var max_new_cases = formatted_data.reduce(function (prev, current) {
                return (prev.new_cases_per_million > current.new_cases_per_million) ? prev : current
            })
            var max_sti = formatted_data.reduce(function (prev, current) {
                return (prev.sti_index > current.sti_index) ? prev : current
            })
          //  console.log(max_new_cases.new_cases_per_million);
          //  console.log(max_sti.sti_index);
            var x = d3.scaleTime()
                .domain(d3.extent(formatted_data, function(d) {
                    return d.parsed_date }))
                .range([ 0, width ]);

            var y_left = d3.scaleLinear()
                .domain([0, max_new_cases.new_cases_per_million])
                .range([height, 0]);

            var y_right = d3.scaleLinear()
                .domain([0, max_sti.sti_index])
                .range([height, 0]);

            var xAxis = d3.axisBottom(x)
                .scale(x);

            var yAxis_left = d3.axisLeft()
                .scale(y_left);

            var yAxis_right = d3.axisRight()
                .scale(y_right);

            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis.tickFormat(d3.timeFormat("%b%y")).ticks(17));


            svg.append("g")
                .attr("class", "y-axis-left")
                .call(yAxis_left);

            svg.append("g")
                .attr("transform", "translate(" + width + " ,0)")
                .attr("class", "y-axis-right")
                .call(yAxis_right);

            var path_new_cases = svg.append("path")
                .datum(formatted_data)
                .attr("fill", "none")
                .attr("stroke", function(d){ return color(d.location) })
                .attr("stroke-width", 3)
                .attr("class", "new-cases")
                .attr("d", d3.line()
                    .defined(d => !isNaN(d.new_cases_per_million))
                    .x(function(d) {
                       // console.log(d.date);
                       // console.log(d.parsed_date);
                       // console.log("x",x(d.parsed_date));
                        return x(d.parsed_date) })
                    .y(function(d) {
                       // console.log("y",y_left(+d.new_cases_per_million));
                        return y_left(+d.new_cases_per_million)
                    })
                )
                .call(transition);

            var path_sti = svg.append("path")
                .datum(formatted_data)
                .attr("fill", "none")
                .attr("stroke", function(d){ return color(d.location) })
                .attr("stroke-width", 3)
                .attr("class", "sti")
                .attr("d", d3.line()
                    .defined(d => !isNaN(d.sti_index))
                    .x(function(d) {
                       // console.log(d.date);
                       // console.log(d.parsed_date);
                        // console.log("x",x(d.parsed_date));
                        return x(d.parsed_date) })
                    .y(function(d) {
                        // console.log("y",y_left(+d.new_cases_per_million));
                        return y_left(+d.sti_index)
                    })
                )
                .call(transition);

           /* var linegraph = svg.append("path")
                .data(rawdata)
                .enter()

/!*         var valueline = d3.svg.line()
                .x(function(d) { return x(d.date); })
                .y(function(d) { return yAxis_left(d.close); });

            var valueline2 = d3.svg.line()
                .x(function(d) { return x(d.date); })
                .y(function(d) { return yAxis_right(d.open); });*!/


                .attr("d", d3.line()
                        .x(function(d) {
                            return x(d.pasred_date);
                        })
                        .y(function(d) {
                            return y_left(d.new_cases_per_million);
                        }))
                .attr("stroke-width", 1.5)
                .style("stroke", "rgb(000,255,000)");
*/
            /*var path_new_cases = svg.selectAll(".linegraph").append("path")
                .attr("d", function(d) { return line(d.sti_index); })
                .style("stroke", "rgb(000,000,000)");
*/
        //    console.log(path_sti);
        //    console.log(path_sti);
         //   console.log(path_sti.node());
          //  console.log(path_sti[0][1]);
          //  console.log(path_new_cases);
      //      var totalLengthSti = [path_sti[0].getTotalLength(), path_sti[1].getTotalLength()];

      ///      var totalLengthNewCases = [path_new_cases[0][0].getTotalLength(), path_new_cases[0][1].getTotalLength()];
        //    console.log(totalLengthSti);
/*            d3.select(path_sti[0][0])
                .attr("stroke-dasharray", totalLengthSti[0] + " " + totalLengthSti[0] )
                .attr("stroke-dashoffset", totalLengthSti[0])
                .transition()
                .duration(5000)
                .ease("linear")
                .attr("stroke-dashoffset", 0);

            d3.select(path_sti[0][1])
                .attr("stroke-dasharray", totalLengthSti[1] + " " + totalLengthSti[1] )
                .attr("stroke-dashoffset", totalLengthSti[1])
                .transition()
                .duration(5000)
                .ease("linear")
                .attr("stroke-dashoffset", 0);*/
        }
        //Function to update the data
        function updateChart(country,rawdata){
            var counry_data = rawdata.filter(function(d){
                return d.location == country;
            });
            //     console.log("update ",counry_data);
            var formatted_data=format_data(counry_data);

            var max_new_cases = formatted_data.reduce(function (prev, current) {
                return (prev.new_cases_per_million > current.new_cases_per_million) ? prev : current
            })
            var max_sti = formatted_data.reduce(function (prev, current) {
                return (prev.sti_index > current.sti_index) ? prev : current
            })




            var x = d3.scaleTime()
                .domain(d3.extent(formatted_data, function(d) {
                    return d.parsed_date }))
                .range([ 0, width ]);


            var y_left = d3.scaleLinear()
                .domain([0, max_new_cases.new_cases_per_million])
                .range([height, 0]);

            var y_right = d3.scaleLinear()
                .domain([0, max_sti.sti_index])
                .range([height, 0]);

            var xAxis = d3.axisBottom(x)
                .scale(x);

            var yAxis_left = d3.axisLeft()
                .scale(y_left);

            var yAxis_right = d3.axisRight()
                .scale(y_right);





            svg.select("g.x-axis")
                .transition() // <---- Here is the transition
                .duration(2000) // 2 seconds
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis.tickFormat(d3.timeFormat("%b%y")).ticks(17));


            svg.select("g.y-axis-left")
                .transition() // <---- Here is the transition
                .duration(2000) // 2 seconds
                .call(yAxis_left);

            svg.select("g.y-axis-right")
                .transition() // <---- Here is the transition
                .duration(2000) // 2 seconds
                .call(yAxis_right);

            svg.select("path.new-cases")
                .data(formatted_data)
                .transition() // <---- Here is the transition
                .duration(2000) // 2 seconds
                .attr("fill", "none")
                .attr("stroke", function(d){ return color(d.location) })
                .attr("stroke-width", 3)
                .attr("d", d3.line()
                    .defined(d => !isNaN(d.new_cases_per_million))
                    .x(function(d) {
                        // console.log(d.date);
                        // console.log(d.parsed_date);
                        // console.log("x",x(d.parsed_date));
                        return x(d.parsed_date) })
                    .y(function(d) {
                        // console.log("y",y_left(+d.new_cases_per_million));
                        return y_left(+d.new_cases_per_million)
                    })
                )
                .call(transition);
        }

        initGraph(data);

    });

</script>